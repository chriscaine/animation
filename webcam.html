<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <link href="bootstrap.css" rel="stylesheet" />
    <style type="text/css">
        body {
            background-color:#222;
        }
        #monitor {
            position: relative;
            width: 400px;
            height: 300px;
            padding: 0;
            margin: 0;
        }

            #monitor video {
                position: absolute;
                top: 0;
                left: 0;
                z-index: 10;
                opacity: 1;
                transition: opacity .1s linear;
            }

                #monitor video:hover {
                    opacity: .5;
                }

            #monitor img {
                position: absolute;
                top: 0;
                left: 0;
                z-index: 5;
            }
    </style>
</head>
<body>

    <div class="container-fluid" style="margin-top: 10px;">
        <div class="row-fluid">
            <div class="col-xs-5">
                <div id="monitor" style="margin:auto;">
                    <img id="image" width="400" height="300" />
                    <video autoplay width="400" height="300" id="video"></video>
                </div>
                <div style="display:flex;  justify-content:space-around; margin-top:10px; height:100px;">
                    <button class="btn btn-primary btn-lg" id="btn-shutter">Capture Frame</button>
                    <button class="btn btn-default btn-lg" id="btn-export">Render Video</button>

                </div>
                <div><a href="#" download="myAnimation.webm" id="export-link" class="btn btn-link">Save As</a></div>
            </div>
            <div class="col-xs-7">
                <canvas id="previewCanvas" width="640" height="480" style="background-color:#666; margin:auto;"></canvas>
                <div class="alert alert-info" style="width:640px;" id="frame-count-display"></div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="col-xs-12" style="text-align:center;">
                <video id="output" controls="controls" width="400" height="300">


                </video>

            </div>

        </div>


    </div>






    <ul id="messages"></ul>
    <script src="webworker/RecordRTC.js?seed=1"></script>
    <script src="scripts/rx.lite.min.js"></script>
    <script>
        "use strict";
        // load webservice
        var Observable = Rx.Observable;
        var Subject = Rx.Subject;

        var frameRate = 6;

        function log(message) {
            var messages = document.getElementById('messages');
            var m = document.createElement('li');
            m.innerHTML = JSON.stringify(message.data);
            messages.appendChild(m);
        }

        function leadingZero(number) {
            //if (number < 10) return '0000' + number.toString();
            //if (number < 100) return '000' + number.toString();
            //if (number < 1000) return '00' + number.toString();
            //if (number < 10000) return '0' + number.toString();
            return number.toString();
        }
        function format(str, replacements) {
            return str.replace(/\{([0-9]{1,3})\}/g, function (a, b) { return replacements[b]; });
        }

        function getEl(selector) {
            return document.querySelector(selector);
        }

        function exporting(duration) {
            var recorder = RecordRTC(canvas, {
                type: 'canvas'
            });

            // REQUIRES SET TIMEOUT TO SET UP PLAYER
            singlePlay = false;
            i = 0;
            recorder.startRecording();
            singlePlay = true;
            var stop = false;

            setTimeout(() => recorder.stopRecording(function () {
                var blob = recorder.getBlob();
                document.getElementById('output').src = URL.createObjectURL(blob);
                document.getElementById('export-link').href = URL.createObjectURL(blob);
                singlePlay = null;
            }), duration * 1000);

        }


        var canvas = document.getElementById('previewCanvas');
        var ctx = canvas.getContext('2d');
        var previewImage = document.getElementById('previewImage');
        function draw(frame, info) {
            getEl('#frame-count-display').innerText = format("{2} Frame {0} of {1} @ {3} fps", [info.index + 1, info.length, info.exporting, info.frameRate]);
            var img = new Image();
            img.onload = function () {
                ctx.drawImage(img, 0, 0, img.width, img.height);
            }
            img.src = URL.createObjectURL(frame.data);
        }


        var worker = new Worker(format('webworker/myWebWorker.js?seed={0}', [Math.floor(Math.random() * 1000)]));

        /* REGISTER STREAMS */

        /* WORKER */
        var workerEvent$ = Observable.fromEvent(worker, 'message').map(x => x.data).share();
        var workerReady$ = workerEvent$.filter(x => x.type === 'ready');
        var workerStart$ = workerEvent$.filter(x => x.type === 'start');
        var workerStdout$ = workerEvent$.filter(x => x.type === 'stdout');
        var workerDone$ = workerEvent$.filter(x => x.type === 'done');
        var video$ = workerDone$.map(function (x) { console.log(x); return x.data[0]; });
        /* - INPUTS */
        var shutterClick$ = Observable.fromEvent(getEl('#btn-shutter'), 'click');//.merge(Observable.timer(1000, 500)).take(120);

        var exportClick$ = Observable.fromEvent(getEl('#btn-export'), 'click');



        //function () {

        //
        //}
        //        var newFrame$ = new Subject();
        var frames$ = shutterClick$.flatMapLatest(function captchaFrame(e) {
            //canvas = null;
            return Observable.fromPromise(new Promise(function (fulfill, reject) {
                var w = video.videoWidth;
                var h = video.videoHeight;
                var videoAspect = w / h;
                var canvas;
                canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                var cxt = canvas.getContext('2d');
                cxt.drawImage(video, 0, 0, w, h);
                canvas.toBlob(function (blob) {
                    fulfill(blob);
                }, 'image/jpeg', 0.7);
            }));
        }).scan(function (frames, blob) {
            //        console.log(frames.length);
            document.querySelector('#image').src = URL.createObjectURL(blob);
            if (blob) frames.push({ name: format('image_{0}.jpg', [leadingZero(frames.length)]), data: blob });
            return frames;
        }, []).share();


        var export$ = exportClick$.withLatestFrom(frames$).map(x => x[1]);

        /* SUBSCRIPTIONS */
        // frames$.subscribe(x => console.log(x));

        workerReady$.subscribe(function (e) { console.log(e); });
        shutterClick$.subscribe(function () { }, function () { }, function () {
            //  getEl('#btn-export').click();
        });

        var _frames = [];
        frames$.subscribe(function (frames) {
            _frames = frames

        });


        var i = 0;
        var singlePlay = null;
        function nextFrame() {
            var _frameRate = frameRate;
            if (singlePlay === null) {
                if (_frames[i]) draw(_frames[i], { index: i, length: _frames.length, exporting: '', frameRate: _frameRate });
                if (i > _frames.length) {
                    i = 0;
                } else {
                   
                    i++;
                }
            } else {
                if (singlePlay === true) {
                    if (_frames[i]) draw(_frames[i], { index: i, length: _frames.length, exporting: 'Exporting' });
                    i++;
                } else {
                    if (_frames[0]) draw(_frames[0], { index: 1, length: _frames.length, exporting: 'Exporting' });
                }
            }
        }
        setInterval(() =>  window.requestAnimationFrame(nextFrame), Math.round(1000 / frameRate));




        export$.subscribe(function (frames) {
            exporting(frames.length / frameRate);
            return;
            //  console.log(frames);

            //function load(url, callback) {
            //    var xhr = new XMLHttpRequest();
            //    xhr.open('GET', url, true);
            //    xhr.responseType = 'blob';
            //    xhr.onload = function (e) {
            //        if (this.status == 200) {
            //            callback(this.response);
            //        }
            //    };
            //    xhr.send();
            //}


            //var out = new Blob();
            //worker.postMessage({
            //    type: 'command',
            //    arguments: [
            //       '-i', 'image_%d.jpg',
            //       '-f', 'image2',
            //        '-r', '24',
            //        '-c:v', 'mpeg4',
            //        '-b:v', '600k',
            //     //   '-analyzeduration', '50',
            //     //   '-probesize', '20',
            //     //   '-strict', 'experimental',
            //        '-y',
            //        '-stats',
            //        'output2.mp4'
            //    ],
            //    //files: ['test.mp4', new Uint8Array(e)]
            //    files: frames
            //});

            //load('/test.mp4', function (e) { });

        });

        /* WORKER */
        workerReady$.subscribe(function () { });

        workerStart$.subscribe(log);
        workerEvent$.subscribe(log);

        video$.subscribe(function (result) {
            var blob;
            if (result) blob = new Blob([result.data], { type: 'video/mp4' });
        });

        /* ****** */



        var video = document.getElementById('video');


        function useWebCamStream(stream) {
            let videoStream = stream;

            console.info('Connecting: ', stream.getVideoTracks()[0].label);

            if (video.mozSrcObject !== undefined) { //FF18a
                video.mozSrcObject = stream;
            } else {
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function () {
                //  video.width = getInitialWidth();
                //  video.height = getInitialWidth() / (video.videoWidth / video.videoHeight);

            }
        }




        function UseImage(src) {
            document.getElementById('image').src = src;
        }


        navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(useWebCamStream);


    </script>
</body>
</html>
